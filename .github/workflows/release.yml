name: Release

on:
  push:
    branches: ['master']

jobs:
  package:
    runs-on: ubuntu-latest
    outputs:
      source: ${{ steps.zip.outputs.source }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
      - name: Install pnpm
        shell: sh
        run: npm install -g pnpm
      - name: Build
        shell: sh
        run: pnpm build
      - name: Copy to temp
        shell: sh
        run: |
          mkdir /tmp/VandyScheduler
          cp -r ./{css,png,dist,manifest.json} /tmp/VandyScheduler/
      - name: Zip
        id: zip
        shell: sh
        run: |
          cd /tmp/VandyScheduler
          zip -rq ../VandyScheduler.zip *
          echo "source=/tmp/VandyScheduler.zip" >> "$GITHUB_OUTPUT"
  release:
    needs: package
    runs-on: ubuntu-latest
    env:
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      REFRESH_TOKEN: ${{ secrets.REFRESH_TOKEN }}
    steps:
      - name: Upload & publish
        shell: sh
        run: pnpm release --source ${{ needs.package.outputs.source }} --extension-id ${{ vars.EXTENSION_ID }}
